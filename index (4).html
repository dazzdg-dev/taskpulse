<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V8.9</title>

<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#050611" />

<style>
:root{
  --bg:#050611;
  --card:#141725;
  --ink:#e9ecf5;
  --muted:#a7b0cf;
  --line:#262a3c;
  --pill:#1b2440;
  --pad:14px;
  --radius:16px;
  --tap:50px;
  --fs:16px;
  --accent:#27b7ff;
  --accent-soft:#193b66;
  --good:#76e0a6;
  --bad:#ff8ea1;
}
@media (max-width:480px){
  :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px; }
}
*{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  margin:0;
  padding:0;
}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  font-size:var(--fs);
  background:radial-gradient(circle at top,#1d2440 0,#050611 55%);
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:12px;
}

/* Shell */
.shell{
  max-width:900px;
  width:100%;
  background:#050814;
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.7);
  padding:16px 18px 14px;
  border:1px solid #20263c;
}
.wrap{
  max-width:820px;
  margin:0 auto;
  padding:4px var(--pad) calc(40px + env(safe-area-inset-bottom));
}

/* Header */
.hero-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo-pill{
  width:42px;
  height:42px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 20%,#5fffd0 0,#0fd0ff 40%,#0b1428 80%);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 0 18px rgba(0,255,213,.5);
  font-weight:800;
  letter-spacing:.03em;
  color:#fff;
}
.brand-title{font-size:18px;font-weight:700;}
.brand-sub{font-size:11px;color:var(--muted);}
.top-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
  font-size:11px;
  color:var(--muted);
}
.badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid #3b425d;
  font-size:11px;
  background:var(--pill);
}
.badge.good{border-color:#3bd47a;color:#7fffb3;}
.badge.warn{border-color:#e7a74c;color:#ffd78a;}

/* KPI pill row */
.kpi-pill{
  margin:6px 0 10px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(10,15,30,.9);
}

/* Tabs */
.tabs{
  position:sticky;
  top:0;
  z-index:50;
  padding:4px 0 4px;
  background:linear-gradient(180deg, rgba(5,8,20,.98) 0%, rgba(5,8,20,.88) 70%, rgba(5,8,20,0) 100%);
  backdrop-filter:saturate(130%) blur(4px);
  margin-bottom:6px;
}
.tabbar{
  display:flex;
  gap:6px;
  overflow:auto;
  padding-bottom:4px;
}
.tabbar button{
  flex:1;
  min-width:110px;
  padding:7px 10px;
  font-size:13px;
  border-radius:999px;
  border:1px solid transparent;
  background:var(--pill);
  color:var(--muted);
  cursor:pointer;
  font-weight:500;
  white-space:nowrap;
}
.tabbar button.active{
  background:linear-gradient(135deg,#27b7ff,#4df2ff);
  color:#04101b;
  font-weight:600;
  box-shadow:0 0 18px rgba(39,183,255,.6);
}
.tabpage{display:none;}
.tabpage.active{display:block;}

/* Cards & layout */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:10px 10px 8px;
  margin:8px 0;
  box-shadow:0 6px 30px rgba(0,0,0,.25);
}
.row{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
}
input,select,button{
  border-radius:999px;
  border:1px solid var(--line);
  background:#050814;
  color:var(--ink);
  padding:7px 11px;
  min-height:var(--tap);
  font-size:13px;
}
input[type=text]{flex:1 1 200px; min-width:0;}
button.primary{
  background:linear-gradient(135deg,#27b7ff,#4df2ff);
  color:#04101b;
  border:none;
  font-weight:600;
  cursor:pointer;
  white-space:nowrap;
}
button{cursor:pointer;}
.btn-ghost{
  background:transparent;
  border:1px solid var(--line);
  color:var(--muted);
}
.btn-danger{
  background:rgba(224,82,100,.12);
  border:1px solid #e05264;
  color:#ff9da8;
}
.muted{color:var(--muted);}
.list{list-style:none;margin:0;padding:0;}

.focus-toggle{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:var(--muted);
}

/* Task rows */
.task{
  display:grid;
  grid-template-columns:auto 1fr auto auto;
  gap:8px;
  align-items:center;
  padding:7px 8px;
  margin-bottom:4px;
  border-radius:10px;
  background:#101528;
  border:1px solid #1e2234;
}
.task input[type="checkbox"]{width:15px;height:15px;}
.task div:first-of-type{
  min-height:40px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.priority{
  display:inline-block;
  border-radius:999px;
  padding:1px 6px;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.04em;
  margin-top:4px;
}
.p-low{background:#16352b;color:#7af3b1;}
.p-med{background:#3a321b;color:#ffe08a;}
.p-high{background:#3d1b25;color:#ff9ab2;}
.stars button{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:14px;
  opacity:.35;
}
.stars button.on{
  opacity:1;
  text-shadow:0 0 8px rgba(255,215,120,.7);
}
.actions{display:flex;gap:4px;}
.actions button{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:15px;
  padding:0 2px;
  color:#99a4d2;
}
.actions .del{color:#ff9ba9;}
.task .meta{
  margin-top:4px;
  font-size:12px;
  color:#9fb0d0;
  opacity:.9;
}
.sum{
  display:flex;
  justify-content:space-between;
  padding:7px 10px;
  background:#0e1324;
  border:1px solid var(--line);
  border-radius:12px;
  font-size:12px;
  margin-top:6px;
}
.nav{display:flex;gap:4px;justify-content:flex-end}

/* History list */
.hist-row{
  border-radius:12px;
  border:1px solid var(--line);
  padding:10px 12px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#101528;
}
.hist-row .meta{color:#9fb0d0;font-size:12px;margin-top:4px;}
.hist-row button{
  border-radius:999px;
  padding:6px 10px;
}

/* Weekly review */
#weeklyReviewCard{display:none;margin-top:4px;}
.weekly-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  align-items:end;
  gap:6px;
  margin-top:8px;
}
.weekly-bar{
  height:40px;
  border-radius:999px;
  background:#090d18;
  border:1px solid #252b46;
  overflow:hidden;
}
.weekly-bar-fill{
  width:100%;
  background:linear-gradient(180deg,#42f4c2,#148f70);
  border-radius:999px;
  height:0%;
}

/* Banners */
#carryWarn{
  display:none;
  margin:6px 0 0 0;
  padding:6px 9px;
  border-radius:9px;
  background:#221525;
  border:1px solid #b26ad5;
  font-size:11px;
  color:#f0d5ff;
}
#medsReminder{
  display:none;
  margin:8px 0 0 0;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #514111;
  background:#161307;
  color:#ffe099;
  font-weight:600;
}

/* Meds card */
.meds-card{padding:10px 10px 12px;}
.meds-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.meds-head-title{font-size:14px;font-weight:600;}
.meds-head-tag{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  background:#101828;
  color:#9fd2ff;
  border:1px solid #294064;
}
.meds-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:6px;
}
.meds-btn{
  flex:1 1 150px;
  min-width:0;
  border-radius:16px;
  padding:10px 14px;
  background:#060817;
  border:1px solid #2b3653;
  text-align:left;
  display:flex;
  flex-direction:column;
  gap:2px;
  color:#e9f2ff;
}
.meds-btn-title{
  font-size:13px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:6px;
}
.meds-btn-sub{
  font-size:11px;
  color:#a7b8d9;
}
.meds-btn-taken{
  background:linear-gradient(90deg,#10d6a0 0%, #028067 40%, #031623 100%);
  border-color:#3df3bd;
  box-shadow:0 0 18px rgba(61,243,189,0.55);
  color:#f6fffe;
}
.meds-btn-taken .meds-btn-sub{color:#d7fff3;}

/* New countdown pill */
.meds-count-wrap{
  margin-top:4px;
  padding:10px 12px 11px;
  border-radius:16px;
  background:linear-gradient(135deg,#343c8a,#5c6dff);
  border:1px solid #505fff;
  text-align:center;
  box-shadow:0 12px 25px rgba(40,60,150,0.55);
}
.meds-count-label{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:#cfd6ff;
  margin-bottom:4px;
}
.meds-count-value{
  font-size:21px;
  font-weight:650;
  color:#ffffff;
}
.meds-meta-row{
  margin-top:4px;
  font-size:11px;
  color:#8fa2d5;
}

/* Splash */
#splash{
  position:fixed;
  inset:0;
  z-index:9999;
  background:radial-gradient(circle at top,#201816 0,#050611 55%);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#splash::before{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(circle at top,#262129 0,#050611 60%);
  opacity:0;
  animation:zoomfade 1.8s ease forwards;
}
#splash .label{
  position:relative;
  text-align:center;
  color:#fff;
  text-shadow:0 6px 26px rgba(0,0,0,.55);
  animation:textin .6s ease both .15s;
}
#splash h2{margin:0;font-size:28px;letter-spacing:.4px;}
#splash .sub{opacity:.85;margin-top:8px;font-size:13px;}
#splash .foot{
  position:absolute;
  bottom:18px;
  width:100%;
  text-align:center;
  font-size:13px;
  opacity:.85;
}
@keyframes zoomfade{
  0%{opacity:0;transform:scale(1.04);}
  15%{opacity:1;}
  100%{opacity:0;transform:scale(1);}
}
@keyframes textin{
  from{opacity:0;transform:translateY(6px);}
  to{opacity:1;transform:translateY(0);}
}
.hide-splash #splash{display:none;}

/* Mobile tweaks */
@media (max-width:600px){
  .shell{padding:14px 10px 12px;}
  .hero-header{flex-direction:column;align-items:flex-start;gap:8px;}
  .top-right{align-items:flex-start;}
  .task{grid-template-columns:auto 1fr auto;}
  .task .actions{grid-column:1 / -1;justify-content:flex-end;}
}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="label">
    <h2>Task Pulse Smart</h2>
    <div class="sub">Powered by Daryl G Â· Focus Â· Sync Â· Achieve (V8.9)</div>
    <div class="foot">Loading your dayâ€¦</div>
  </div>
</div>

<div class="shell">
  <div class="wrap">
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor Â· V8.9</div>
        </div>
      </div>
      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <div class="kpi-pill" id="kpiRow">
      <span>0 / 0 done (0%) Â· Quality 0%</span>
      <span id="todayLabel" class="muted">â€”</span>
    </div>

    <div id="carryWarn"></div>
    <div id="medsReminder"></div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

    <!-- TAB: TASKS -->
    <div id="tab-tasks" class="tabpage active">
      <!-- Meds -->
      <section class="card meds-card" id="medsCard">
        <div class="meds-head">
          <div class="meds-head-title">Medication â€” Today</div>
          <div class="meds-head-tag">TLE routine</div>
        </div>
        <div class="meds-row">
          <button id="btnMedsDay" class="meds-btn" onclick="toggleMeds('day')" title="Log/undo Morning dose">
            <span class="meds-btn-title">ðŸŒ… Morning Dose</span>
            <span class="meds-btn-sub">Tap to log</span>
          </button>
          <button id="btnMedsNight" class="meds-btn" onclick="toggleMeds('night')" title="Log/undo Night dose">
            <span class="meds-btn-title">ðŸŒ™ Night Dose</span>
            <span class="meds-btn-sub">Tap to log</span>
          </button>
        </div>

        <div class="meds-meta-row" id="medsMeta"></div>

        <div class="meds-count-wrap">
          <div class="meds-count-label">Next dose</div>
          <div id="medsCountdown" class="meds-count-value">â€”</div>
        </div>
      </section>

      <!-- Tasks -->
      <section class="card">
        <h3 style="margin:0 0 8px">Today's Tasks</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="taskInput" type="text" placeholder="Add taskâ€¦" list="taskSuggestions" autocomplete="off"
                 oninput="tpRenderDatalist(this.value)" />
          <datalist id="taskSuggestions"></datalist>
          <select id="prioSelect">
            <option value="low">low</option>
            <option value="med">med</option>
            <option value="high">high</option>
          </select>
          <button class="primary" onclick="addTask()">Add</button>
        </div>
        <div class="row" style="justify-content:space-between">
          <div class="focus-toggle">
            <input id="focusLaneCheckbox" type="checkbox" onchange="toggleFocusLane()" />
            <label for="focusLaneCheckbox">Focus lane (only high priority, starred & carried)</label>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
            <button class="btn-ghost" onclick="manualCarryOver()" title="Move all incomplete tasks to tomorrow">
              Carry incomplete â†’ tomorrow
            </button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Viewing</div>
            <div id="viewingLabel" style="font-weight:600">â€”</div>
          </div>
          <div class="nav">
            <button class="btn-ghost" onclick="shiftDay(-1)">â—€</button>
            <button class="btn-ghost" onclick="shiftDay(+1)">â–¶</button>
          </div>
        </div>
        <ul id="taskList" class="list" style="margin-top:8px"></ul>
        <div class="sum">
          <div id="doneSummary">0 / 0 tasks done (0%)</div>
          <div id="qualitySummary">Quality 0%</div>
        </div>
      </section>
    </div>

    <!-- TAB: HISTORY -->
    <div id="tab-history" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 8px">History</h3>
        <div class="row" style="gap:6px;margin-bottom:6px">
          <input id="histSearch" type="text" placeholder="Search text or YYYY-MM-DDâ€¦" oninput="renderHistory()" />
          <select id="histSpan" onchange="renderHistory()">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="histList"></div>
      </section>

      <section class="card" id="weeklyReviewCard">
        <h3 style="margin:0 0 8px">Weekly Review</h3>
        <div class="muted" style="font-size:12px">
          Each bar = one day Â· Height = completion %
        </div>
        <div id="weeklyGrid" class="weekly-grid"></div>
      </section>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 8px">Sync</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="syncCode" placeholder="Sync code" style="flex:1 1 260px" />
          <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
          <button class="btn-ghost" onclick="newSyncCode()">New code</button>
          <button class="primary" onclick="saveSyncCode()">Save</button>
        </div>
        <div class="muted" style="font-size:12px;">
          Open this site on your second device and use the same code. Sync uses Firebase Realtime Database.
        </div>
      </section>

      <section class="card" id="backupCard">
        <h3 style="margin:0 0 8px">Backup &amp; Restore</h3>
        <div class="row" style="align-items:center">
          <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">â­³  Download Backup</button>
          <input id="tpRestoreFile" type="file" accept="application/json" style="display:none" />
          <button id="btnRestore" class="btn-ghost"
                  onclick="document.getElementById('tpRestoreFile').click()">â­±  Import Backup</button>
        </div>
        <div id="tpBackupStatus" class="muted" style="margin-top:6px;font-size:12px;"></div>
      </section>
    </div>
  </div>

  <footer style="margin-top:4px;text-align:center;font-size:11px;color:var(--muted);">
    Task Pulse Smart V8.9 Â· Powered by D Gounder
  </footer>
</div>

<!-- Firebase (optional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
// TODO: paste your Firebase config here, e.g.:
// const firebaseConfig = { ... };
// firebase.initializeApp(firebaseConfig);
</script>

<script>
/* ================= CORE KEYS & GLOBALS ================= */
const LS_KEY         = 'tp_days_v1';
const LS_SYNC        = 'tp_sync_code';
const LS_TAB         = 'tp_last_tab';
const LS_LAST_OPEN   = 'tp_last_open';
const LS_MEDS        = 'tp_meds_v1';
const LS_CARRY_COUNT = 'tp_last_carry_count';
const LS_FOCUS_MODE  = 'tp_focus_lane';

let days = load(LS_KEY, {});
let meds = load(LS_MEDS, {});
let viewing = todayIso();

let tpDirty = false;

function baseSave(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function save(k,v){
  try{ baseSave(k,v); tpDirty=false; }
  catch(e){ tpDirty=true; }
  // push to sync if relevant
  if(k===LS_KEY || k===LS_MEDS) notifyLocalChanged();
}
setInterval(()=>{ if(tpDirty) baseSave(LS_KEY, days); }, 3000);

window.addEventListener('beforeunload',()=>{
  try{
    baseSave(LS_KEY, days);
    baseSave(LS_MEDS, meds);
  }catch{}
});

/* ================= BASIC UTILS ================= */
function todayIso(){ return new Date().toISOString().slice(0,10); }
function isoOffset(iso, days){
  const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10);
}
function load(k,def){
  try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }
  catch(e){ return def; }
}
function ensureDay(iso){
  if(!days[iso]) days[iso]=[];
  return days[iso];
}
function medsFor(iso){
  if(!meds[iso]) meds[iso]={day:'',night:''};
  return meds[iso];
}
function fmtHumanDate(iso){
  const d=new Date(iso);
  return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
}
function fmtDateTime(iso){
  try{
    const d=new Date(iso);
    const date=d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    const time=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    return `${date} Â· ${time}`.replace(/\s+/g,' ');
  }catch{ return ''; }
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g,m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

/* ============== SPLASH & DOM READY ============== */
window.addEventListener('load',()=>{
  setTimeout(()=>document.body.classList.add('hide-splash'),1800);
});

document.addEventListener('DOMContentLoaded',()=>{
  const lastTab = localStorage.getItem(LS_TAB)||'tasks';
  showTab(lastTab);

  ensureSyncCode();
  tpUpdateLastBackupLabel();

  autoCarryForwardIfNewDay();
  showCarryBannerIfAny();

  restoreFocusMode();
  tpRenderDatalist('');
  renderAll();
  renderHistory();

  renderMeds();
  updateMedsReminder();
  startCountdownLoop();
});

/* =================== TABS =================== */
function showTab(id){
  document.querySelectorAll('.tabpage').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+id)?.classList.add('active');

  document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btnTab'+cap(id))?.classList.add('active');

  localStorage.setItem(LS_TAB,id);
  if(id==='history') renderHistory();
}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* =================== FOCUS LANE =================== */
function toggleFocusLane(){
  const chk=document.getElementById('focusLaneCheckbox');
  const on=chk.checked;
  localStorage.setItem(LS_FOCUS_MODE, on?'1':'0');
  document.body.classList.toggle('focus-active', on);
  renderAll();
}
function restoreFocusMode(){
  const on=localStorage.getItem(LS_FOCUS_MODE)==='1';
  const chk=document.getElementById('focusLaneCheckbox');
  chk.checked=on;
  document.body.classList.toggle('focus-active', on);
}

/* =================== MEDS LOGIC =================== */
function toggleMeds(which){
  const today=todayIso();
  const m=medsFor(today);
  if(m[which]){
    if(!confirm('Unmark this dose as taken?')) return;
    m[which]='';
  }else{
    m[which]=new Date().toISOString();
  }
  save(LS_MEDS, meds);
  renderMeds();
  updateMedsReminder();
}

function renderMeds(){
  const today=todayIso();
  const m=medsFor(today);
  const btnDay=document.getElementById('btnMedsDay');
  const btnNight=document.getElementById('btnMedsNight');
  const meta=document.getElementById('medsMeta');

  if(btnDay){
    const taken=!!m.day;
    const sub = taken ? `Logged Â· ${fmtDateTime(m.day)}` : 'Tap to log';
    btnDay.className='meds-btn'+(taken?' meds-btn-taken':'');
    btnDay.querySelector('.meds-btn-sub').textContent=sub;
  }
  if(btnNight){
    const taken=!!m.night;
    const sub = taken ? `Logged Â· ${fmtDateTime(m.night)}` : 'Tap to log';
    btnNight.className='meds-btn'+(taken?' meds-btn-taken':'');
    btnNight.querySelector('.meds-btn-sub').textContent=sub;
  }

  if(meta){
    const d = m.day   ? `Morning: ${fmtDateTime(m.day)}` : 'Morning: â€”';
    const n = m.night ? `Night: ${fmtDateTime(m.night)}` :  'Night: â€”';
    meta.textContent = `${d}   â€¢   ${n}`;
  }
  // countdown label handled by separate loop
}

/* Simple banner: Morning / Night not taken */
function updateMedsReminder(){
  const bar=document.getElementById('medsReminder');
  const m=medsFor(todayIso());
  let msg='';
  if(!m.day && !m.night) msg='Morning & Night Meds not taken';
  else if(!m.day) msg='Morning Meds not taken';
  else if(!m.night) msg='Night Meds not taken';
  if(msg){
    bar.textContent=msg;
    bar.style.display='block';
  }else{
    bar.style.display='none';
  }
}

/* ============ COUNTDOWN (SMART) ============ */
let countdownTimer=null;

function startCountdownLoop(){
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer=setInterval(updateCountdown,1000);
  updateCountdown();
}

function computeNextDoseTarget(){
  const today=todayIso();
  const m = medsFor(today);

  if(!m.day){
    return {target:null, mode:'need-morning'};
  }
  const dayLogged=new Date(m.day);

  if(!m.night){
    // next is tonight
    return {
      target:new Date(dayLogged.getTime()+12*60*60*1000),
      mode:'night'
    };
  }
  // morning + night taken -> next is tomorrow morning at same time as today morning
  return {
    target:new Date(dayLogged.getTime()+24*60*60*1000),
    mode:'next-morning'
  };
}

function updateCountdown(){
  const el=document.getElementById('medsCountdown');
  if(!el) return;

  const cfg=computeNextDoseTarget();
  if(!cfg.target){
    el.textContent='Morning dose pendingâ€¦';
    return;
  }

  const now=new Date();
  let diff = cfg.target - now;

  if(diff<=0){
    el.textContent = cfg.mode==='night'
      ? 'Night dose due now'
      : 'Morning dose due now';
    return;
  }

  const h = Math.floor(diff/3600000);
  diff%=3600000;
  const m = Math.floor(diff/60000);
  diff%=60000;
  const s = Math.floor(diff/1000);

  el.textContent = `${h}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
}

/* =================== TASKS =================== */
function addTask(){
  const name=document.getElementById('taskInput').value.trim();
  const prio=document.getElementById('prioSelect').value;
  if(!name) return;
  const t={
    id:'t_'+Math.random().toString(36).slice(2,8),
    name, prio,
    done:false,
    stars:0,
    createdAt:new Date().toISOString()
  };
  ensureDay(viewing).unshift(t);
  save(LS_KEY,days);
  document.getElementById('taskInput').value='';
  renderAll();
  tpRenderDatalist('');
}

function toggleDone(dayKey,id,el){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.done=el.checked;
  t.timeCompleted=t.done?new Date().toISOString():'';
  save(LS_KEY,days);
  renderAll();
}

function setStars(dayKey,id,s){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.stars=(s===t.stars)?0:s;
  save(LS_KEY,days);
  renderAll();
}

function editTask(dayKey,id){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  const name=prompt('Edit task', t.name);
  if(name===null) return;
  let prio=prompt('Priority (low/med/high)', t.prio) || t.prio;
  if(!['low','med','high'].includes(prio)) prio=t.prio;
  t.name=name.trim();
  t.prio=prio;
  save(LS_KEY,days);
  renderAll();
}

function delTask(dayKey,id){
  if(!confirm('Delete task?')) return;
  days[dayKey]=ensureDay(dayKey).filter(x=>x.id!==id);
  save(LS_KEY,days);
  renderAll();
}

function clearCompleted(){
  days[viewing]=ensureDay(viewing).filter(x=>!x.done);
  save(LS_KEY,days);
  renderAll();
}

function shiftDay(d){
  const dt=new Date(viewing);
  dt.setDate(dt.getDate()+d);
  viewing=dt.toISOString().slice(0,10);
  renderAll();
}

/* =================== CARRY LOGIC =================== */
function manualCarryOver(){
  const list=ensureDay(viewing);
  const incomplete=list.filter(t=>!t.done);
  if(!incomplete.length){
    alert('No incomplete tasks to carry.');
    return;
  }
  const tomorrow=isoOffset(viewing,+1);
  ensureDay(tomorrow).unshift(...incomplete.map(t=>({
    ...t,
    id:'t_'+Math.random().toString(36).slice(2,8),
    createdAt:new Date().toISOString()
  })));
  days[viewing]=list.filter(t=>t.done);
  save(LS_KEY,days);
  renderAll();
  alert(`Carried ${incomplete.length} task(s) to ${fmtHumanDate(tomorrow)}.`);
}

function autoCarryForwardIfNewDay(){
  const last=load(LS_LAST_OPEN,'');
  const today=todayIso();
  let carried=0;

  if(last && last!==today){
    const prev=ensureDay(last).filter(t=>!t.done);
    if(prev.length){
      const dest=ensureDay(today);
      dest.unshift(...prev.map(t=>({
        ...t,
        id:'t_'+Math.random().toString(36).slice(2,8),
        createdAt:new Date().toISOString()
      })));
      days[last]=ensureDay(last).filter(t=>t.done);
      carried=prev.length;
      save(LS_KEY,days);
    }
  }
  localStorage.setItem(LS_LAST_OPEN,today);
  localStorage.setItem(LS_CARRY_COUNT,String(carried));
}

function showCarryBannerIfAny(){
  const cnt=parseInt(localStorage.getItem(LS_CARRY_COUNT)||'0',10);
  const bar=document.getElementById('carryWarn');
  if(cnt>0){
    bar.style.display='block';
    bar.textContent=`âš ï¸ ${cnt} incomplete task(s) were automatically carried over to today.`;
  }else{
    bar.style.display='none';
  }
}

/* =================== RENDER ALL =================== */
function renderAll(){
  const todayLabel=document.getElementById('todayLabel');
  if(todayLabel) todayLabel.textContent=fmtHumanDate(todayIso());

  const viewingLabel=document.getElementById('viewingLabel');
  if(viewingLabel) viewingLabel.textContent=fmtHumanDate(viewing);

  const list=ensureDay(viewing);
  const ul=document.getElementById('taskList');
  const focusOn = localStorage.getItem(LS_FOCUS_MODE)==='1';

  if(ul){
    ul.innerHTML='';
    list.forEach(t=>{
      if(focusOn){
        const high = t.prio==='high';
        const starred = t.stars>0;
        const carried = (!t.done && viewing!==todayIso());
        if(!(high || starred || carried)) return;
      }

      const li=document.createElement('li');
      li.className='task';

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=t.done;
      cb.onchange=e=>toggleDone(viewing,t.id,e.target);

      const center=document.createElement('div');
      const prioc=t.prio==='low'?'p-low':t.prio==='med'?'p-med':'p-high';
      const completedMeta=(t.done&&t.timeCompleted)
        ? `<div class="meta">âœ” ${fmtDateTime(t.timeCompleted)}</div>`
        : '';

      center.innerHTML=`
        <div style="font-weight:600;${t.done?'text-decoration:line-through;opacity:.7':''}">
          ${escapeHtml(t.name)}
        </div>
        <div><span class="priority ${prioc}">${t.prio}</span></div>
        ${completedMeta}
      `;

      const stars=document.createElement('div');
      stars.className='stars';
      for(let s=1;s<=3;s++){
        const b=document.createElement('button');
        b.textContent='â˜…';
        if(t.stars>=s) b.classList.add('on');
        b.onclick=()=>setStars(viewing,t.id,s);
        stars.appendChild(b);
      }

      const act=document.createElement('div');
      act.className='actions';
      const eBtn=document.createElement('button');
      eBtn.textContent='âœŽ';
      eBtn.onclick=()=>editTask(viewing,t.id);
      const dBtn=document.createElement('button');
      dBtn.textContent='Ã—';
      dBtn.className='del';
      dBtn.onclick=()=>delTask(viewing,t.id);
      act.appendChild(eBtn);
      act.appendChild(dBtn);

      li.appendChild(cb);
      li.appendChild(center);
      li.appendChild(stars);
      li.appendChild(act);
      ul.appendChild(li);
    });
  }

  const total=list.length;
  const done=list.filter(t=>t.done).length;
  const pct=total?Math.round(done/total*100):0;
  const q=list.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct=done?Math.round((q/(done*3))*100):0;

  document.getElementById('doneSummary').textContent =
    `${done} / ${total} tasks done (${pct}%)`;
  document.getElementById('qualitySummary').textContent =
    `Quality ${qPct}%`;

  const kpiRow=document.getElementById('kpiRow');
  if(kpiRow && kpiRow.firstElementChild){
    kpiRow.firstElementChild.textContent =
      `${done} / ${total} done (${pct}%) Â· Quality ${qPct}%`;
  }

  renderMeds();
}

/* =================== HISTORY + WEEKLY =================== */
function renderHistory(){
  const wrap=document.getElementById('histList');
  if(!wrap) return;

  const q=document.getElementById('histSearch').value.trim().toLowerCase();
  const spanSel=document.getElementById('histSpan').value;

  let keys=Object.keys(days||{});
  if(spanSel!=='all'){
    const span=parseInt(spanSel,10);
    const min=new Date();
    min.setDate(min.getDate()-span);
    keys=keys.filter(k=>new Date(k)>=min);
  }

  if(q){
    keys=keys.filter(k=>{
      if(k.includes(q)) return true;
      return (days[k]||[]).some(t=>(t.name||'').toLowerCase().includes(q));
    });
  }

  keys.sort((a,b)=>new Date(b)-new Date(a));
  wrap.innerHTML='';

  if(!keys.length){
    wrap.innerHTML='<div class="muted">No history found.</div>';
    document.getElementById('weeklyReviewCard').style.display='none';
    return;
  }

  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;
    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct=done?Math.round((qsum/(done*3))*100):0;

    const row=document.createElement('div');
    row.className='hist-row';

    const left=document.createElement('div');
    left.innerHTML=`
      <div style="font-weight:700">${fmtHumanDate(k)}</div>
      <div class="meta">${done}/${total} done â€¢ ${pct}% Â· Quality ${qPct}%</div>
    `;

    const right=document.createElement('div');
    const btn=document.createElement('button');
    btn.textContent='Open';
    btn.onclick=()=>{ viewing=k; showTab('tasks'); renderAll(); };
    right.appendChild(btn);

    row.appendChild(left);
    row.appendChild(right);
    wrap.appendChild(row);
  });

  renderWeeklyReview(keys);
}

function renderWeeklyReview(dateKeys){
  const card=document.getElementById('weeklyReviewCard');
  const grid=document.getElementById('weeklyGrid');
  if(!dateKeys.length){ card.style.display='none'; return; }

  const last7=dateKeys.slice(0,7).reverse();
  grid.innerHTML='';

  last7.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;

    const bar=document.createElement('div');
    bar.className='weekly-bar';
    const fill=document.createElement('div');
    fill.className='weekly-bar-fill';
    fill.style.height=pct+'%';

    bar.appendChild(fill);
    grid.appendChild(bar);
  });

  card.style.display='block';
}

/* =================== BACKUP =================== */
function tpUpdateLastBackupLabel(){
  const el=document.getElementById('tpLastBackup');
  if(!el) return;
  el.textContent = 'Last backup: ' + (localStorage.getItem('tp_last_backup') || 'none');
}

(function(){
  function buildBackup(){
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^tp_/.test(k)) dump[k]=localStorage.getItem(k);
    }
    dump[LS_KEY]=JSON.stringify(days||{});
    dump[LS_MEDS]=JSON.stringify(meds||{});
    return {
      app:'taskpulse',
      flavor:'v8.9',
      exportedAt:new Date().toISOString(),
      dump
    };
  }

  window.tpDownloadBackup=function(){
    try{
      const payload=buildBackup();
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='taskpulse_backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      localStorage.setItem('tp_last_backup', new Date().toLocaleString());
      tpUpdateLastBackupLabel();
      document.getElementById('tpBackupStatus').textContent='Backup downloaded.';
    }catch(e){
      console.error('Backup failed',e);
      alert('Backup failed: '+e.message);
    }
  };

  const fi=document.getElementById('tpRestoreFile');
  if(fi){
    fi.addEventListener('change', async e=>{
      const f=e.target.files[0];
      if(!f) return;
      try{
        const text=await f.text();
        const data=JSON.parse(text);
        if(data && data.dump){
          Object.entries(data.dump).forEach(([k,v])=>{
            if(/^tp_/.test(k)) localStorage.setItem(k,v);
          });
        }
        document.getElementById('tpBackupStatus').textContent='Restore complete. Reloadingâ€¦';
        setTimeout(()=>location.reload(),600);
      }catch(err){
        console.error('Restore failed',err);
        alert('Restore failed: '+err.message);
      }finally{
        e.target.value='';
      }
    });
  }
})();

/* =================== SYNC =================== */
const TP_UID = (localStorage.getItem('tp_uid') || (()=>{
  const v='u_'+Math.random().toString(36).slice(2,10);
  localStorage.setItem('tp_uid',v);
  return v;
})());

let syncRef=null, syncOff=null, writeTimer=null;

function setSyncBadge(text,kind=''){
  const el=document.getElementById('syncState');
  if(!el) return;
  el.textContent=text;
  el.className='badge '+(kind||'');
}

const SYNC_PREFIX='grp-';
function randomCode(len=6){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function isFirebaseReady(){
  return (window.firebase && firebase.apps && firebase.apps.length);
}

function ensureSyncCode(){
  let code=localStorage.getItem(LS_SYNC);
  if(!code){
    code=SYNC_PREFIX+randomCode(6);
    localStorage.setItem(LS_SYNC,code);
  }
  const inp=document.getElementById('syncCode');
  if(inp) inp.value=code;
  if(isFirebaseReady()) attachSync(code);
}

function copySyncCode(){
  const i=document.getElementById('syncCode');
  if(!i || !i.value) return;
  navigator.clipboard.writeText(i.value).then(()=>alert('Sync code copied'));
}

function newSyncCode(){
  if(!confirm('Generate a new sync code? Devices must use this new code.')) return;
  const code=SYNC_PREFIX+randomCode(6);
  localStorage.setItem(LS_SYNC,code);
  const inp=document.getElementById('syncCode');
  if(inp) inp.value=code;
  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(code);
  alert('New code generated.');
}

function saveSyncCode(){
  const i=document.getElementById('syncCode');
  if(!i) return;
  const v=(i.value||'').trim();
  if(!v) return;
  localStorage.setItem(LS_SYNC,v);
  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(v);
  alert('Sync code saved.');
}

function notifyLocalChanged(){ debouncedPush(); }
function debouncedPush(){
  if(!syncRef) return;
  clearTimeout(writeTimer);
  writeTimer=setTimeout(()=>{
    syncRef.set({
      days,
      meds,
      _meta:{by:TP_UID,at:Date.now()}
    }).catch(console.warn);
  },250);
}

function attachSync(code){
  if(!isFirebaseReady()){
    setSyncBadge('Local-only');
    return;
  }
  if(!code) return;

  if(syncOff) syncOff();
  syncRef=firebase.database().ref('taskpulse/'+code);
  setSyncBadge('Sync: '+code,'good');

  syncRef.get().then(snap=>{
    const val=snap.val();
    if(val && (val.days || val.meds)){
      days = mergeDays(days,val.days||{});
      meds = mergeMeds(meds,val.meds||{});
      baseSave(LS_KEY,days);
      baseSave(LS_MEDS,meds);
      renderAll();
      renderMeds();
    }else{
      debouncedPush();
    }
  }).catch(e=>{
    console.warn(e);
    setSyncBadge('Sync error','warn');
  });

  const handler=syncRef.on('value',snap=>{
    const val=snap.val(); if(!val) return;
    if(val._meta && val._meta.by===TP_UID) return;
    if(val.days){ days=mergeDays(days,val.days); baseSave(LS_KEY,days); }
    if(val.meds){ meds=mergeMeds(meds,val.meds); baseSave(LS_MEDS,meds); }
    renderAll();
    renderMeds();
  });
  syncOff=()=>syncRef.off('value',handler);
}

function mergeDays(localDays,remoteDays){
  const out={...(localDays||{})};
  for(const d of Object.keys(remoteDays||{})){
    if(!out[d]){ out[d]=remoteDays[d]; continue; }
    const L=out[d]||[], R=remoteDays[d]||[];
    const stamp=arr=>arr.reduce((m,t)=>Math.max(m,new Date(t.timeCompleted||t.createdAt||0).getTime()),0);
    out[d]=(stamp(R)>stamp(L))?R:L;
  }
  return out;
}

function mergeMeds(localM,remoteM){
  const out={...(localM||{})};
  for(const day of Object.keys(remoteM||{})){
    const r=remoteM[day]||{}, l=out[day]||{day:'',night:''};
    const pick=(a,b)=>{ const ta=a?Date.parse(a):0, tb=b?Date.parse(b):0; return (tb>ta)?b:a; };
    out[day]={day:pick(l.day,r.day), night:pick(l.night,r.night)};
  }
  return out;
}

/* =================== PREDICTIVE SUGGESTIONS =================== */
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days||{})){
    for(const t of (days[dk]||[])){
      const nm=(t.name||'').trim();
      if(!nm) continue;
      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||t.updatedAt||t.date||new Date()).getTime();
      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key); s.count++; s.last=Math.max(s.last,last);
    }
  }
  return stats;
}
function tpRankedNames(stats){
  return Array.from(stats.values())
    .sort((a,b)=>(b.count-a.count)||(b.last-a.last))
    .map(v=>v.name);
}
function tpGetSuggestions(prefix){
  const ranked=tpRankedNames(tpCollectTaskStats());
  const p=(prefix||'').trim().toLowerCase();
  if(!p) return ranked.slice(0,10);
  const pref=ranked.filter(n=>n.toLowerCase().startsWith(p));
  if(pref.length>=10) return pref.slice(0,10);
  const rest=ranked.filter(n=>!n.toLowerCase().startsWith(p)
                               && n.toLowerCase().includes(p));
  return [...pref,...rest].slice(0,10);
}
function tpRenderDatalist(prefix){
  const dl=document.getElementById('taskSuggestions');
  if(!dl) return;
  const opts=tpGetSuggestions(prefix);
  dl.innerHTML=opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
}

/* =================== SERVICE WORKER =================== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
