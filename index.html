<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Pulse</title>
  <meta name="theme-color" content="#1d1d1f" />

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
    body{background:#f4f4f6;max-width:480px;margin:0 auto;color:#1a1a1a}
    .hidden{display:none!important}.small{font-size:.8rem;color:#666}

    /* Splash */
    #splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;
      background:#000;display:flex;align-items:center;justify-content:center;
      z-index:9999;opacity:1;transition:opacity 1s ease-in-out}
    #splash-screen.fade-out{opacity:0;pointer-events:none}
    #splash-screen img{width:100%;height:100%;object-fit:cover}

    header{background:radial-gradient(circle at 20% 20%,#2c2c2f 0%,#1d1d1f 60%);
      color:#fff;padding:16px;border-bottom:1px solid #000;border-radius:0 0 20px 20px}
    .today-label{font-size:.8rem;color:#bdbdbd}
    .today-date{font-size:1.1rem;font-weight:600}

    main{padding:16px 16px 80px}
    .today-block,.history-block,.settings-block{
      background:#fff;border:1px solid #ededed;border-radius:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.05);padding:16px;margin-bottom:20px}

    .section-headline{display:flex;justify-content:space-between;margin-bottom:12px}
    .section-title{font-size:1rem;font-weight:600}

    .task-row{display:flex;justify-content:space-between;border:1px solid #e4e4e7;
      border-radius:12px;padding:12px;margin-bottom:10px}
    .task-check{width:20px;height:20px;border-radius:6px;border:2px solid #1d1d1f;
      display:flex;align-items:center;justify-content:center;font-size:.7rem;cursor:pointer}
    .task-check.done{background:#1d1d1f;color:#fff}
    .priority-pill{font-size:.7rem;border-radius:6px;padding:2px 6px;text-transform:uppercase;font-weight:600}
    .priority-high{background:#ff4d4d;color:#fff}
    .priority-med{background:#ffb84d;color:#1a1a1a}
    .priority-low{background:#d9d9d9;color:#1a1a1a}

    .add-row{display:flex;flex-direction:column;gap:10px;background:#f9f9fa;
      border:1px dashed #cfcfd3;border-radius:12px;padding:12px;margin-top:16px}
    .add-top{display:flex;flex-wrap:wrap;gap:8px}
    .add-input,.priority-select{border:1px solid #cfcfd3;border-radius:10px;padding:10px 12px;font-size:.9rem;background:#fff}
    .add-input{flex:1}
    .add-btn{border-radius:10px;background:#1d1d1f;color:#fff;border:1px solid #1d1d1f;font-size:.85rem;padding:10px 14px}

    .history-nav button{background:#fff;border:1px solid #cfcfd3;padding:8px 10px;
      border-radius:10px;font-size:1rem}

    .settings-action{background:#1d1d1f;color:#fff;border:1px solid #1d1d1f;
      border-radius:10px;padding:8px 10px;font-size:.8rem}
  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash-screen">
    <img src="TaskPulse_Splash_Powered_By_DarylG.png" alt="Task Pulse Splash" />
  </div>

  <!-- Header -->
  <header>
    <div class="today-label">Today</div>
    <div class="today-date" id="todayDate">--</div>
  </header>

  <!-- Version marker -->
  <div style="text-align:center;font-size:.7rem;color:#999;padding:4px 0;">
    build: sync-enabled-v1
  </div>

  <main>
    <!-- Today -->
    <section id="todaySection" class="today-block">
      <div class="section-headline">
        <div class="section-title">Today's Tasks</div>
        <div class="section-sub" id="todayStats">0 / 0 done (0%)</div>
      </div>
      <div id="todayTaskList"></div>
      <div class="add-row">
        <div class="add-top">
          <input id="newTaskName" class="add-input" placeholder="Add task…" />
          <select id="newTaskPriority" class="priority-select">
            <option value="high">high</option>
            <option value="med">med</option>
            <option value="low" selected>low</option>
          </select>
          <button id="addTaskBtn" class="add-btn">Add</button>
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="screen-history" class="history-block">
      <div class="section-headline">
        <div>
          <div class="small">Viewing</div>
          <div id="historyDateLabel" style="font-size:.9rem;font-weight:600;color:#111;">--</div>
        </div>
        <div class="history-nav">
          <button id="prevDayBtn">◀</button>
          <button id="nextDayBtn">▶</button>
        </div>
      </div>
      <div class="small" id="historyStats" style="margin-bottom:12px;">--</div>
      <div id="historyTaskList"></div>
    </section>

    <!-- Sync -->
    <section id="screen-settings" class="settings-block">
      <div class="section-title">Sync between devices</div>
      <p style="font-size:.8rem;margin-bottom:12px;">
        This code links multiple devices to the same Task Pulse list.
        Both devices must paste/use the same code. Data is synced using Firebase.
      </p>
      <div>
        <div class="small" style="font-weight:600;">Your Sync Code</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="syncCodeDisplay" class="add-input" readonly style="font-family:monospace;font-size:.8rem;">
          <button id="copySyncCodeBtn" class="settings-action">Copy</button>
        </div>
      </div>
      <br>
      <div>
        <div class="small" style="font-weight:600;">Join using Sync Code</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="syncCodeInput" class="add-input" placeholder="paste code here">
          <button id="joinSyncBtn" class="settings-action">Join</button>
        </div>
      </div>
      <p class="small" style="margin-top:12px;color:#444;line-height:1.4;">
        After joining, both devices use the SAME shared list in realtime.
      </p>
    </section>
  </main>

<script>
/* ---------------------------
   0. SPLASH
----------------------------*/
function hideSplashScreen(){
  const s=document.getElementById('splash-screen');
  if(!s)return;
  setTimeout(()=>s.classList.add('fade-out'),1800);
}

/* ---------------------------
   1. DATE / UTILITIES
----------------------------*/
function todayISO(){
  const d=new Date();
  // local YYYY-MM-DD
  return [
    d.getFullYear(),
    String(d.getMonth()+1).padStart(2,"0"),
    String(d.getDate()).padStart(2,"0")
  ].join("-");
}
function fmtDate(iso){
  const[y,m,d]=iso.split("-");
  return `${d}-${m}-${y}`;
}
function nowTime(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function shiftDate(iso,days){
  const[y,m,d]=iso.split("-");
  const base=new Date(Number(y),Number(m)-1,Number(d));
  base.setDate(base.getDate()+days);
  return [
    base.getFullYear(),
    String(base.getMonth()+1).padStart(2,"0"),
    String(base.getDate()).padStart(2,"0")
  ].join("-");
}

/* ---------------------------
   2. LOCAL STORAGE FALLBACK
----------------------------*/
function loadTasksLocal(){
  return JSON.parse(localStorage.getItem('tp_tasks')||'[]');
}
function saveTasksLocal(tasks){
  localStorage.setItem('tp_tasks',JSON.stringify(tasks));
}
function getSyncCodeLocal(){
  return localStorage.getItem('tp_sync_code')||null;
}
function setSyncCodeLocal(code){
  localStorage.setItem('tp_sync_code',code);
}
function createTask({name,priority,dateAssigned,status,timeCompleted}){
  return {
    id:'t_'+Math.random().toString(36).slice(2,9),
    name,
    priority,
    status:status||'not done',
    timeCompleted:timeCompleted||'',
    dateAssigned:dateAssigned||todayISO()
  };
}

/* ---------------------------
   3. FIREBASE SETUP
----------------------------*/

/*** IMPORTANT:
     1. Go to Firebase console
     2. Create project
     3. Enable Anonymous Auth
     4. Create Realtime Database
     5. Paste your config below
***/

const firebaseConfig = {
  apiKey: "PASTE_YOUR_apiKey_HERE",
  authDomain: "PASTE_YOUR_authDomain_HERE",
  databaseURL: "PASTE_YOUR_databaseURL_HERE",
  projectId: "PASTE_YOUR_projectId_HERE",
  storageBucket: "PASTE_YOUR_storageBucket_HERE",
  messagingSenderId: "PASTE_YOUR_senderId_HERE",
  appId: "PASTE_YOUR_appId_HERE"
};

// initialize
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

// current auth user
let currentUser = null;
// this is the shared list ID. all devices w/ same code share tasks.
let activeSyncCode = null;

// reference to the tasks branch in the DB for this sync code
function tasksRef(){
  if(!activeSyncCode) return null;
  return db.ref("tasklists/"+activeSyncCode+"/tasks");
}

/* ---------------------------
   4. CLOUD SYNC HELPERS
----------------------------*/

// pull from cloud to local
function downloadTasksFromCloud(){
  if(!tasksRef()) return;
  tasksRef().once("value").then(snap=>{
    const data=snap.val()||{};
    // convert object map -> array
    const arr=Object.values(data);
    saveTasksLocal(arr);
    renderAll();
  });
}

// push local to cloud
function uploadTasksToCloud(){
  if(!tasksRef()) return;
  const localTasks=loadTasksLocal();
  // convert array -> object keyed by id
  const obj={};
  for(const t of localTasks){
    obj[t.id]=t;
  }
  tasksRef().set(obj);
}

// realtime listener
function startRealtimeSync(){
  if(!tasksRef()) return;
  tasksRef().on("value",snap=>{
    const data=snap.val()||{};
    const arr=Object.values(data);
    saveTasksLocal(arr);
    renderAll();
  });
}

/* ---------------------------
   5. AUTH / SYNC CODE BOOTSTRAP
----------------------------*/
function ensureSignedInAnon(){
  return new Promise((resolve,reject)=>{
    if(currentUser){
      resolve(currentUser);
      return;
    }
    auth.signInAnonymously()
      .then(cred=>{
        currentUser=cred.user;
        resolve(currentUser);
      })
      .catch(err=>reject(err));
  });
}

// pick or create sync code
function initSyncCode(){
  // 1. try local stored code
  let code = getSyncCodeLocal();

  // 2. if none, generate one from uid
  if(!code){
    // use user uid prefix so each device is unique initially
    const short = currentUser && currentUser.uid
      ? currentUser.uid.slice(0,6)
      : Math.random().toString(36).slice(2,8);
    code = "grp-"+short;
    setSyncCodeLocal(code);
  }

  activeSyncCode = code;
  const syncField=document.getElementById("syncCodeDisplay");
  if(syncField){ syncField.value = activeSyncCode; }
}

// user taps "Join"
function joinSyncCode(newCode){
  if(!newCode) return;
  activeSyncCode=newCode;
  setSyncCodeLocal(newCode);
  const syncField=document.getElementById("syncCodeDisplay");
  if(syncField){ syncField.value = activeSyncCode; }

  // re-start sync under new code
  startRealtimeSync();
  downloadTasksFromCloud();
  uploadTasksToCloud();
}

/* ---------------------------
   6. TASK LIST RENDERING
----------------------------*/
function renderHeaderToday(){
  document.getElementById("todayDate").textContent=fmtDate(todayISO());
}

// TODAY list
function renderTodayList(){
  const listEl   = document.getElementById("todayTaskList");
  const statsEl  = document.getElementById("todayStats");
  const allTasks = loadTasksLocal();
  const today    = todayISO();

  const todaysTasks = allTasks.filter(t=>t.dateAssigned===today);
  const doneCt      = todaysTasks.filter(t=>t.status==='done').length;
  const totalCt     = todaysTasks.length;
  const pct         = totalCt?Math.round((doneCt/totalCt)*100):0;

  statsEl.textContent = `${doneCt} / ${totalCt} done (${pct}%)`;

  listEl.innerHTML = todaysTasks.map(t=>{
    const done = t.status==='done'?'done':'';
    const prClass = t.priority==='high'
      ? 'priority-high'
      : t.priority==='med'
      ? 'priority-med'
      : 'priority-low';
    return `
      <div class="task-row" data-id="${t.id}">
        <div class="task-check ${done}" data-role="toggleTask">${done?'✓':''}</div>
        <div style="flex:1;margin-left:8px;">
          <div><span class="task-name">${escapeHTML(t.name)}</span>
            <span class="priority-pill ${prClass}">${t.priority}</span></div>
          <div class="small">${
            t.status==='done'
              ? '✔ Done at '+(t.timeCompleted||'—')
              : 'Not done'
          }</div>
        </div>
      </div>`;
  }).join("");

  listEl.querySelectorAll('[data-role="toggleTask"]').forEach(chk=>{
    chk.onclick=()=>{
      const row=chk.closest('.task-row');
      const id=row.dataset.id;
      toggleTaskDone(id);
    };
  });
}

// toggle done / not done
function toggleTaskDone(id){
  const tasks=loadTasksLocal();
  const i=tasks.findIndex(t=>t.id===id);
  if(i<0)return;
  const task=tasks[i];

  if(task.status==='done'){
    task.status='not done';
    task.timeCompleted='';
  } else {
    task.status='done';
    task.timeCompleted=nowTime();
  }

  saveTasksLocal(tasks);
  renderAll();
  uploadTasksToCloud();
}

// ADD new task
function addTask(){
  const nameInput=document.getElementById("newTaskName");
  const prioSel  =document.getElementById("newTaskPriority");
  const nm=nameInput.value.trim();
  const pr=prioSel.value;
  if(!nm)return;

  const tasks=loadTasksLocal();
  tasks.push(createTask({name:nm,priority:pr}));
  saveTasksLocal(tasks);

  nameInput.value='';
  prioSel.value='low';

  renderAll();
  uploadTasksToCloud();
}

/* ---------------------------
   7. HISTORY
----------------------------*/
let historyDate = todayISO();

function renderHistory(){
  const tasks=loadTasksLocal();
  const dayTasks=tasks.filter(t=>t.dateAssigned===historyDate);
  const doneCt  =dayTasks.filter(t=>t.status==='done').length;
  const pct     =dayTasks.length?Math.round((doneCt/dayTasks.length)*100):0;

  document.getElementById("historyDateLabel").textContent=fmtDate(historyDate);
  document.getElementById("historyStats").textContent=
    `${doneCt} / ${dayTasks.length} tasks done (${pct}%)`;

  document.getElementById("historyTaskList").innerHTML = dayTasks.map(t=>{
    return `<div class="small">• ${escapeHTML(t.name)} (${t.priority}) — ${t.status}</div>`;
  }).join('');
}

/* ---------------------------
   8. SYNC UI BINDINGS
----------------------------*/
function bindSyncUI(){
  const copyBtn=document.getElementById("copySyncCodeBtn");
  const joinBtn=document.getElementById("joinSyncBtn");

  if(copyBtn){
    copyBtn.onclick=()=>{
      const field=document.getElementById("syncCodeDisplay");
      if(field && field.value){
        navigator.clipboard.writeText(field.value);
      }
    };
  }

  if(joinBtn){
    joinBtn.onclick=()=>{
      const field=document.getElementById("syncCodeInput");
      if(field && field.value.trim()){
        joinSyncCode(field.value.trim());
        field.value="";
      }
    };
  }
}

/* ---------------------------
   9. RENDER ALL
----------------------------*/
function escapeHTML(str){
  return str.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
}
function renderAll(){
  renderHeaderToday();
  renderTodayList();
  renderHistory();
}

/* ---------------------------
   10. INIT
----------------------------*/
function init(){
  hideSplashScreen();

  // bind UI basics
  document.getElementById("addTaskBtn").onclick=addTask;

  // prev / next day for history
  document.getElementById("prevDayBtn").onclick=()=>{
    historyDate=shiftDate(historyDate,-1);
    renderAll();
  };
  document.getElementById("nextDayBtn").onclick=()=>{
    historyDate=shiftDate(historyDate,1);
    renderAll();
  };

  bindSyncUI();

  // auth -> sync code -> realtime
  ensureSignedInAnon()
    .then(()=>{
      initSyncCode();          // sets activeSyncCode
      startRealtimeSync();     // listen for changes
      downloadTasksFromCloud();// pull first copy
      uploadTasksToCloud();    // push our local up
    })
    .catch(err=>{
      console.log("auth error, fallback to local only",err);
      // even if auth fails, local still works
    })
    .finally(()=>{
      renderAll();
    });

  // service worker (offline install)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
  }
}

// go
init();
</script>

</body>
</html>
