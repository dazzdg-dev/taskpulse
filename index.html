<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Pulse</title>
  <meta name="theme-color" content="#1d1d1f" />

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    body {
      background:#f4f4f6;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,Roboto,'Segoe UI',sans-serif;
      max-width:480px;
      margin:0 auto;
      border-left:1px solid #d6d6d6;
      border-right:1px solid #d6d6d6;
    }
    .hidden{display:none!important;}

    /* Splash screen */
    #splash-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: #1d1d1f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1s ease-in-out;
    }
    #splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    #splash-screen img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    header{
      background:radial-gradient(circle at 20% 20%,#2c2c2f 0%,#1d1d1f 60%);
      color:#fff;
      padding:16px;
      border-bottom:1px solid #000;
      border-radius:0 0 20px 20px;
      box-shadow:0 12px 32px rgba(0,0,0,.4);
    }
    .today-label{font-size:.8rem;color:#bdbdbd;font-weight:500;}
    .today-date{color:#fff;font-size:1.1rem;font-weight:600;line-height:1.3;}

    main{padding:16px 16px 80px;}
    .history-nav button{
      background:#fff;border:1px solid #cfcfd3;color:#1d1d1f;
      padding:8px 10px;border-radius:10px;font-weight:500;min-width:70px;
    }
    .settings-block{
      background:#fff;border-radius:16px;border:1px solid #ededed;
      box-shadow:0 10px 24px rgba(0,0,0,0.05);
      padding:16px;margin-bottom:16px;
      font-size:.8rem;color:#444;
    }
    .settings-title{
      font-size:.9rem;font-weight:600;color:#111;margin-bottom:8px;
    }
    .bulk-input{
      border:1px solid #cfcfd3;border-radius:10px;
      padding:10px 12px;font-size:.9rem;
      outline:none;width:100%;background:#fff;
    }
    .settings-action{
      font-size:.8rem;font-weight:500;
      background:#1d1d1f;color:#fff;
      border-radius:10px;border:1px solid #1d1d1f;
      padding:8px 10px;
    }
    .small{font-size:.8rem;color:#666;}
  </style>
</head>
<body>

  <!-- SPLASH SCREEN -->
  <div id="splash-screen">
    <img src="TaskPulse_Splash_Powered_By_DarylG.png" alt="Task Pulse Splash" />
  </div>

  <header>
    <div class="today-label">Today</div>
    <div class="today-date" id="todayDate">--</div>
  </header>

  <main>
    <section id="screen-history">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;">
        <div>
          <div class="small">Viewing</div>
          <div id="historyDateLabel" style="font-size:0.9rem;font-weight:600;color:#111;">--</div>
        </div>
        <div class="history-nav" style="display:flex;gap:8px;">
          <button id="prevDayBtn">◀</button>
          <button id="nextDayBtn">▶</button>
        </div>
      </div>

      <div class="small" id="historyStats" style="margin-bottom:12px;">--</div>
      <div id="historyTaskList" style="font-size:.9rem;color:#111;"></div>
    </section>

    <section id="screen-settings">
      <div class="settings-block">
        <div class="settings-title">Sync between devices</div>
        <div style="max-width:100%; margin-bottom:12px;">
          This code links multiple phones/tablets to the SAME Task Pulse list.
        </div>

        <div style="width:100%; margin-bottom:12px;">
          <div class="small" style="font-weight:600; color:#111; margin-bottom:4px;">Your Sync Code</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="syncCodeDisplay" class="bulk-input" style="flex:1; font-family:monospace; font-size:0.8rem;" readonly value="..."/>
            <button class="settings-action" id="copySyncCodeBtn" style="min-width:70px;">Copy</button>
          </div>
        </div>

        <div style="width:100%;">
          <div class="small" style="font-weight:600; color:#111; margin-bottom:4px;">Join using Sync Code</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="syncCodeInput" class="bulk-input" style="flex:1; font-family:monospace; font-size:0.8rem;" placeholder="paste code here"/>
            <button class="settings-action" id="joinSyncBtn" style="min-width:70px;">Join</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Splash fade
    function hideSplashScreen() {
      const splash = document.getElementById('splash-screen');
      if (!splash) return;
      setTimeout(() => {
        splash.classList.add('fade-out');
      }, 1800);
    }

    // FIREBASE CONFIG (placeholder - replace with your real Firebase config)
    const firebaseConfig = {
      apiKey: "YOUR_KEY_HERE",
      authDomain: "YOUR_APP.firebaseapp.com",
      databaseURL: "https://YOUR_APP-default-rtdb.firebaseio.com",
      projectId: "YOUR_APP",
      storageBucket: "YOUR_APP.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUserId = null;
    let activeSyncCode = null;

    function loadSyncCode() {
      const raw = localStorage.getItem('tp_sync_code');
      return raw || null;
    }
    function saveSyncCode(code) {
      localStorage.setItem('tp_sync_code', code);
    }

    function signInAnon() {
      return firebase.auth().signInAnonymously().then(cred => {
        currentUserId = cred.user.uid;
        const existing = loadSyncCode();
        if (existing) {
          activeSyncCode = existing;
        } else {
          activeSyncCode = currentUserId;
          saveSyncCode(activeSyncCode);
        }
        console.log("Signed in as", currentUserId, "sync code:", activeSyncCode);
        startRealtimeSync();
      });
    }

    function userTasksRef() {
      if (!activeSyncCode) return null;
      return firebase.database().ref("users/" + activeSyncCode + "/tasks");
    }

    function uploadTasksToCloud() {
      const tasks = loadTasks();
      const ref = userTasksRef();
      if (!ref) return;
      const obj = {};
      tasks.forEach(t => { obj[t.id] = t; });
      ref.set(obj);
    }

    function downloadTasksFromCloud() {
      const ref = userTasksRef();
      if (!ref) return;
      ref.once("value").then(snap => {
        const cloudData = snap.val() || {};
        const cloudTasks = Object.values(cloudData);
        const local = loadTasks();
        const localById = {};
        local.forEach(t => localById[t.id] = t);
        cloudTasks.forEach(ct => {
          if (!localById[ct.id]) {
            local.push(ct);
          }
        });
        saveTasks(local);
        renderAll();
      });
    }

    function startRealtimeSync() {
      const ref = userTasksRef();
      if (!ref) return;
      ref.on("value", snap => {
        const cloudData = snap.val() || {};
        const cloudTasks = Object.values(cloudData);
        const local = loadTasks();
        const localById = {};
        local.forEach(t => localById[t.id] = t);
        let changed = false;
        cloudTasks.forEach(ct => {
          if (!localById[ct.id]) {
            local.push(ct);
            changed = true;
          }
        });
        if (changed) {
          saveTasks(local);
          renderAll();
        }
      });
    }

    function updateSyncUI() {
      const codeField = document.getElementById('syncCodeDisplay');
      if (codeField && activeSyncCode) {
        codeField.value = activeSyncCode;
      }
    }

    function bindCopySyncCode() {
      const btn = document.getElementById('copySyncCodeBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        const codeField = document.getElementById('syncCodeDisplay');
        if (!codeField) return;
        codeField.select();
        codeField.setSelectionRange(0, 99999);
        try { document.execCommand('copy'); } catch(e) {}
        btn.textContent = "Copied!";
        setTimeout(()=>{ btn.textContent = "Copy"; }, 1500);
      });
    }

    function bindJoinSync() {
      const btn = document.getElementById('joinSyncBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        const input = document.getElementById('syncCodeInput');
        if (!input) return;
        const newCode = input.value.trim();
        if (!newCode) return;
        activeSyncCode = newCode;
        saveSyncCode(newCode);
        startRealtimeSync();
        downloadTasksFromCloud();
        uploadTasksToCloud();
        updateSyncUI();
        btn.textContent = "Linked!";
        setTimeout(()=>{ btn.textContent = "Join"; }, 1500);
      });
    }

    // LOCAL DATA + DATE FIX
    function loadTasks() {
      const raw = localStorage.getItem('tp_tasks');
      return raw ? JSON.parse(raw) : [];
    }
    function saveTasks(tasks) {
      localStorage.setItem('tp_tasks', JSON.stringify(tasks));
    }

    function getLocalISODate(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function todayISO() {
      return getLocalISODate(new Date());
    }
    function shiftDate(iso, days) {
      const [y,m,d] = iso.split("-");
      const base = new Date(Number(y), Number(m)-1, Number(d));
      base.setDate(base.getDate() + days);
      return getLocalISODate(base);
    }
    function fmtDateDisplay(isoDate) {
      if(!isoDate) return '';
      const [y,m,d] = isoDate.split('-');
      return `${d}-${m}-${y}`;
    }

    function nowTimeStr() {
      const d = new Date();
      let hh = d.getHours();
      let mm = d.getMinutes();
      if (hh<10) hh = '0'+hh;
      if (mm<10) mm = '0'+mm;
      return `${hh}:${mm}`;
    }

    function createTask(obj={}) {
      return {
        id: 't_'+Math.random().toString(36).slice(2,9),
        name: obj.name || '',
        priority: obj.priority || 'low',
        status: obj.status || 'not done',
        timeCompleted: obj.timeCompleted || '',
        dateAssigned: obj.dateAssigned || todayISO(),
      };
    }

    // HISTORY
    let historyDate = todayISO();

    function renderHistory() {
      const tasks = loadTasks();
      const dayTasks = tasks.filter(t=>t.dateAssigned===historyDate);
      const doneCt    = dayTasks.filter(t=>t.status==='done').length;
      const totalCt   = dayTasks.length;
      const pct = totalCt>0 ? Math.round((doneCt/totalCt)*100) : 0;
      document.getElementById('historyDateLabel').textContent = fmtDateDisplay(historyDate);
      document.getElementById('historyStats').textContent = `${doneCt} / ${totalCt} tasks done (${pct}%)`;
      document.getElementById('historyTaskList').innerHTML = dayTasks.map(t => {
        return \`<div style="background:#fff;border:1px solid #ededed;border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="font-weight:600;color:#111;font-size:.9rem;">\${t.name}</div>
          <div style="font-size:.75rem;color:#444;margin-top:4px;">
            <b>Priority:</b> \${t.priority.toUpperCase()} |
            <b>Status:</b> \${t.status} |
            <b>Time:</b> \${t.timeCompleted || '—'}
          </div>
        </div>\`;
      }).join('');
    }

    document.getElementById('prevDayBtn').addEventListener('click',()=>{
      historyDate = shiftDate(historyDate,-1);
      renderAll();
    });
    document.getElementById('nextDayBtn').addEventListener('click',()=>{
      historyDate = shiftDate(historyDate,1);
      renderAll();
    });

    // HEADER DATE
    function renderHeaderToday() {
      document.getElementById('todayDate').textContent = fmtDateDisplay(todayISO());
    }

    function renderAll(){
      renderHeaderToday();
      renderHistory();
      updateSyncUI();
    }

    function init(){
      hideSplashScreen(); // splash fade-out

      bindCopySyncCode();
      bindJoinSync();

      signInAnon().then(() => {
        updateSyncUI();
        downloadTasksFromCloud();
      });

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('sw.js');
        });
      }

      renderAll();
    }

    init();
  </script>
</body>
</html>
