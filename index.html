  <!-- single shared hidden file picker (moved ABOVE script so it's in DOM before JS runs) -->
  <input
    id="hiddenFileInput"
    type="file"
    accept="image/*"
    capture="environment"
    style="display:none;"
  />

  <script>
    /************************************
     * 0. SPLASH / ANIMATION
     ************************************/
    function hideSplashScreen() {
      const splash = document.getElementById('splash-screen');
      if (!splash) return;
      setTimeout(() => {
        splash.classList.add('fade-out');
      }, 1800);
    }

    /* ... EVERYTHING ABOVE THIS IN YOUR CURRENT <script> STAYS THE SAME ... */
    /* We only need to replace the bindSyncUI() and the init() section with the updated versions below. */
    /* Scroll down in your existing <script> until you find bindSyncUI() and init(), then overwrite them. */


    /************************************
     * 10. SYNC UI + BUTTON BINDINGS
     ************************************/
    function bindSyncUI(){
      const copyBtn=document.getElementById("copySyncCodeBtn");
      const joinBtn=document.getElementById("joinSyncBtn");
      const clearBtn=document.getElementById("clearCompletedBtn");
      const prevBtn=document.getElementById("prevDayBtn");
      const nextBtn=document.getElementById("nextDayBtn");
      const overlayClose=document.getElementById("imgOverlayClose");

      if(copyBtn){
        copyBtn.onclick=()=>{
          const field=document.getElementById("syncCodeDisplay");
          if(field && field.value){
            navigator.clipboard.writeText(field.value);
          }
        };
      }

      if(joinBtn){
        joinBtn.onclick=()=>{
          const field=document.getElementById("syncCodeInput");
          if(field && field.value.trim()){
            joinSyncCode(field.value.trim());
            field.value="";
          }
        };
      }

      if(clearBtn){
        clearBtn.onclick=()=>{
          clearCompletedToday();
        };
      }

      if(prevBtn){
        prevBtn.onclick=()=>{
          historyDate = shiftDate(historyDate,-1);
          renderAll();
        };
      }

      if(nextBtn){
        nextBtn.onclick=()=>{
          historyDate = shiftDate(historyDate,1);
          renderAll();
        };
      }

      if(overlayClose){
        overlayClose.onclick=()=>{
          closeImagePreview();
        };
      }

      // hidden file input for attaching images
      const picker = document.getElementById("hiddenFileInput");
      if (picker) {
        picker.onchange = ()=>{
          const file = picker.files && picker.files[0];
          handleChosenFile(file);
        };
      }
    }

    /************************************
     * 11. MAIN RENDER
     ************************************/
    function renderAll(){
      document.getElementById("todayDate").textContent = fmtDate(todayISO());
      renderTodayList();
      renderHistory();
    }

    /************************************
     * 12. INIT
     ************************************/
    function init(){
      hideSplashScreen();

      bindSyncUI();

      // auth → sync → rollover → realtime → render
      ensureSignedInAnon()
        .then(()=>{
          initSyncCode();
          rolloverUnfinishedFromYesterday();
          startRealtimeSync();
          downloadTasksFromCloud();
          uploadTasksToCloud();
        })
        .catch(err=>{
          console.log("Auth/sync error. Local-only fallback.", err);
          rolloverUnfinishedFromYesterday();
        })
        .finally(()=>{
          renderAll();
        });

      // PWA offline
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("sw.js");
      }
    }

    init();
  </script>
</body>
</html>
