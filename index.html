<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Pulse</title>
  <meta name="theme-color" content="#1d1d1f" />

  <!-- PWA manifest + icons -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Roboto", "Segoe UI", sans-serif;
    }

    body {
      background:#f4f4f6;
      max-width:480px;
      margin:0 auto;
      border-left:1px solid #d6d6d6;
      border-right:1px solid #d6d6d6;
      color:#1a1a1a;
    }

    .hidden { display:none !important; }
    .small  { font-size:.8rem; color:#666; }

    /* Splash screen */
    #splash-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: #1d1d1f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1s ease-in-out;
    }

    #splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    #splash-screen img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    header{
      background:radial-gradient(circle at 20% 20%,#2c2c2f 0%,#1d1d1f 60%);
      color:#fff;
      padding:16px;
      border-bottom:1px solid #000;
      border-radius:0 0 20px 20px;
      box-shadow:0 12px 32px rgba(0,0,0,.4);
    }

    .today-label{
      font-size:.8rem;
      color:#bdbdbd;
      font-weight:500;
    }

    .today-date{
      color:#fff;
      font-size:1.1rem;
      font-weight:600;
      line-height:1.3;
    }

    main{
      padding:16px 16px 80px;
    }

    /*******************
     * TODAY'S TASKS
     *******************/
    .today-block{
      background:#fff;
      border-radius:16px;
      border:1px solid #ededed;
      box-shadow:0 10px 24px rgba(0,0,0,0.05);
      padding:16px;
      margin-bottom:20px;
    }

    .section-headline{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      margin-bottom:12px;
    }

    .section-title{
      font-size:1rem;
      font-weight:600;
      color:#111;
    }

    .section-sub{
      font-size:.8rem;
      color:#666;
    }

    .task-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border:1px solid #e4e4e7;
      background:#fff;
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
    }

    .task-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:70%;
    }

    .task-topline{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .task-check{
      width:20px;
      height:20px;
      border-radius:6px;
      border:2px solid #1d1d1f;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
      font-weight:600;
      line-height:1;
      cursor:pointer;
      user-select:none;
    }

    .task-check.done{
      background:#1d1d1f;
      color:#fff;
    }

    .task-name{
      font-weight:600;
      color:#111;
      font-size:.9rem;
      line-height:1.3;
      word-break:break-word;
    }

    .priority-pill{
      font-size:.7rem;
      line-height:1.2;
      font-weight:600;
      border-radius:6px;
      padding:2px 6px;
      text-transform:uppercase;
    }

    .priority-high{
      background:#ff4d4d;
      color:#fff;
    }
    .priority-med{
      background:#ffb84d;
      color:#1a1a1a;
    }
    .priority-low{
      background:#d9d9d9;
      color:#1a1a1a;
    }

    .task-meta{
      font-size:.7rem;
      color:#444;
      line-height:1.4;
    }

    /* Add task row */
    .add-row{
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#f9f9fa;
      border:1px dashed #cfcfd3;
      border-radius:12px;
      padding:12px;
      margin-top:16px;
    }

    .add-top{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      width:100%;
    }

    .add-input{
      flex:1;
      min-width:120px;
      border:1px solid #cfcfd3;
      border-radius:10px;
      padding:10px 12px;
      font-size:.9rem;
      outline:none;
      background:#fff;
    }

    .priority-select{
      border:1px solid #cfcfd3;
      border-radius:10px;
      padding:10px 12px;
      font-size:.9rem;
      background:#fff;
      color:#1a1a1a;
      outline:none;
    }

    .add-btn{
      border-radius:10px;
      background:#1d1d1f;
      color:#fff;
      border:1px solid #1d1d1f;
      font-size:.85rem;
      font-weight:500;
      padding:10px 14px;
      min-width:70px;
    }

    /*******************
     * HISTORY
     *******************/
    .history-block{
      background:#fff;
      border-radius:16px;
      border:1px solid #ededed;
      box-shadow:0 10px 24px rgba(0,0,0,0.05);
      padding:16px;
      margin-bottom:20px;
    }

    .history-nav button{
      background:#fff;
      border:1px solid #cfcfd3;
      color:#1d1d1f;
      padding:8px 10px;
      border-radius:10px;
      font-weight:500;
      min-width:44px;
      min-height:36px;
      line-height:1;
      font-size:1rem;
    }

    .history-task-card {
      background:#fff;
      border:1px solid #ededed;
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }

    .task-name-history{
      font-weight:600;
      color:#111;
      font-size:.9rem;
    }

    .task-meta-history{
      font-size:.75rem;
      color:#444;
      margin-top:4px;
      line-height:1.4;
    }

    /*******************
     * SETTINGS
     *******************/
    .settings-block{
      background:#fff;
      border-radius:16px;
      border:1px solid #ededed;
      box-shadow:0 10px 24px rgba(0,0,0,0.05);
      padding:16px;
      margin-bottom:20px;
      font-size:.8rem;
      color:#444;
    }

    .settings-title{
      font-size:.9rem;
      font-weight:600;
      color:#111;
      margin-bottom:8px;
    }

    .bulk-input{
      border:1px solid #cfcfd3;
      border-radius:10px;
      padding:10px 12px;
      font-size:.9rem;
      outline:none;
      width:100%;
      background:#fff;
    }

    .settings-action{
      font-size:.8rem;
      font-weight:500;
      background:#1d1d1f;
      color:#fff;
      border-radius:10px;
      border:1px solid #1d1d1f;
      padding:8px 10px;
    }
  </style>
</head>

<body>

  <!-- SPLASH SCREEN -->
  <div id="splash-screen">
    <img src="TaskPulse_Splash_Powered_By_DarylG.png" alt="Task Pulse Splash" />
  </div>

  <!-- HEADER -->
  <header>
    <div class="today-label">Today</div>
    <div class="today-date" id="todayDate">--</div>
  </header>

  <!-- MAIN -->
  <main>

    <!-- TODAY SECTION -->
    <section id="todaySection" class="today-block">
      <div class="section-headline">
        <div class="section-title">Today's Tasks</div>
        <div class="section-sub" id="todayStats">0 / 0 done (0%)</div>
      </div>

      <div id="todayTaskList"></div>

      <!-- Add Task UI -->
      <div class="add-row">
        <div class="add-top">
          <input id="newTaskName" class="add-input" placeholder="Add task…" />
          <select id="newTaskPriority" class="priority-select">
            <option value="high">high</option>
            <option value="med">med</option>
            <option value="low" selected>low</option>
          </select>
          <button id="addTaskBtn" class="add-btn">Add</button>
        </div>
        <div class="small" style="color:#666;">
          New tasks are automatically tagged with today's date and will
          show up in History for today.
        </div>
      </div>
    </section>

    <!-- HISTORY SECTION -->
    <section id="screen-history" class="history-block">
      <div class="section-headline" style="margin-bottom:16px;">
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div class="small">Viewing</div>
          <div id="historyDateLabel" style="font-size:0.9rem;font-weight:600;color:#111;">--</div>
        </div>
        <div class="history-nav" style="display:flex;gap:8px;">
          <button id="prevDayBtn">◀</button>
          <button id="nextDayBtn">▶</button>
        </div>
      </div>

      <div class="small" id="historyStats" style="margin-bottom:12px;">--</div>
      <div id="historyTaskList" style="font-size:.9rem;color:#111;"></div>
    </section>

    <!-- SETTINGS SECTION -->
    <section id="screen-settings" class="settings-block">
      <div class="settings-title">Sync between devices</div>

      <div style="max-width:100%; margin-bottom:12px; line-height:1.4;">
        This code links multiple phones/tablets to the SAME Task Pulse list.
        (Sync is prepared but currently offline-only. We'll enable cloud once Firebase keys are added.)
      </div>

      <div style="width:100%; margin-bottom:12px;">
        <div class="small" style="font-weight:600; color:#111; margin-bottom:4px;">Your Sync Code</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="syncCodeDisplay" class="bulk-input" style="flex:1; font-family:monospace; font-size:0.8rem;" readonly value="..."/>
          <button class="settings-action" id="copySyncCodeBtn" style="min-width:70px;">Copy</button>
        </div>
        <div class="small" style="color:#666; margin-top:4px; line-height:1.4;">
          Share this with another device to link them.
        </div>
      </div>

      <div style="width:100%;">
        <div class="small" style="font-weight:600; color:#111; margin-bottom:4px;">Join using Sync Code</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="syncCodeInput" class="bulk-input" style="flex:1; font-family:monospace; font-size:0.8rem;" placeholder="paste code here"/>
          <button class="settings-action" id="joinSyncBtn" style="min-width:70px;">Join</button>
        </div>
        <div class="small" style="color:#666; margin-top:4px;">
          After joining, both devices stay synced (when cloud is enabled).
        </div>
      </div>
    </section>
  </main>

  <script>
    /************************************
     * SPLASH HANDLING
     ************************************/
    function hideSplashScreen() {
      const splash = document.getElementById('splash-screen');
      if (!splash) return;
      // fade out after 1.8s
      setTimeout(() => {
        splash.classList.add('fade-out');
      }, 1800);
    }

    /************************************
     * LOCAL STORAGE + DATE HELPERS
     ************************************/
    function loadTasks() {
      const raw = localStorage.getItem('tp_tasks');
      return raw ? JSON.parse(raw) : [];
    }

    function saveTasks(tasks) {
      localStorage.setItem('tp_tasks', JSON.stringify(tasks));
    }

    function loadSyncCode() {
      const raw = localStorage.getItem('tp_sync_code');
      return raw || null;
    }

    function saveSyncCode(code) {
      localStorage.setItem('tp_sync_code', code);
    }

    function getLocalISODate(dateObj) {
      // build YYYY-MM-DD in device local time
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function todayISO() {
      return getLocalISODate(new Date());
    }

    function shiftDate(iso, days) {
      // iso = "YYYY-MM-DD", move forward/back in local time
      const [y,m,d] = iso.split("-");
      const base = new Date(Number(y), Number(m)-1, Number(d));
      base.setDate(base.getDate() + days);
      return getLocalISODate(base);
    }

    function fmtDateDisplay(isoDate) {
      if(!isoDate) return "";
      const [y,m,d] = isoDate.split("-");
      return `${d}-${m}-${y}`;
    }

    function nowTimeStr() {
      const d = new Date();
      let hh = d.getHours();
      let mm = d.getMinutes();
      if (hh < 10) hh = "0" + hh;
      if (mm < 10) mm = "0" + mm;
      return `${hh}:${mm}`;
    }

    function createTask(obj={}) {
      return {
        id: "t_" + Math.random().toString(36).slice(2,9),
        name: obj.name || "",
        priority: obj.priority || "low",
        status: obj.status || "not done",
        timeCompleted: obj.timeCompleted || "",
        dateAssigned: obj.dateAssigned || todayISO(),
      };
    }

    /************************************
     * TODAY'S TASKS RENDER/UPDATE
     ************************************/
    function renderTodayList() {
      const listEl   = document.getElementById("todayTaskList");
      const statsEl  = document.getElementById("todayStats");
      const allTasks = loadTasks();
      const today    = todayISO();

      // only today's tasks
      const todaysTasks = allTasks.filter(t => t.dateAssigned === today);

      const doneCt  = todaysTasks.filter(t => t.status === "done").length;
      const totalCt = todaysTasks.length;
      const pct     = totalCt > 0 ? Math.round((doneCt/totalCt)*100) : 0;

      statsEl.textContent = `${doneCt} / ${totalCt} done (${pct}%)`;

      listEl.innerHTML = todaysTasks.map(t => {
        const isDone = t.status === "done";
        const checkClass = "task-check" + (isDone ? " done" : "");
        const prClass = t.priority === "high"
          ? "priority-pill priority-high"
          : t.priority === "med"
          ? "priority-pill priority-med"
          : "priority-pill priority-low";

        return `
          <div class="task-row" data-id="${t.id}">
            <div class="task-main">
              <div class="task-topline">
                <div class="${checkClass}" data-role="toggleTask">${isDone ? "✓" : ""}</div>
                <div class="task-name">${escapeHTML(t.name)}</div>
                <div class="${prClass}">${t.priority}</div>
              </div>
              <div class="task-meta">
                ${isDone
                  ? `<b>Status:</b> done · <b>Time:</b> ${t.timeCompleted || "—"}`
                  : `<b>Status:</b> not done`}
              </div>
            </div>
          </div>
        `;
      }).join("");

      // bind toggle handlers
      Array.from(listEl.querySelectorAll("[data-role='toggleTask']")).forEach(chk => {
        chk.addEventListener("click", () => {
          const row   = chk.closest(".task-row");
          const id    = row.getAttribute("data-id");
          toggleDone(id);
        });
      });
    }

    function toggleDone(taskId) {
      const tasks = loadTasks();
      const i = tasks.findIndex(t => t.id === taskId);
      if (i === -1) return;

      if (tasks[i].status === "done") {
        // make it not done again
        tasks[i].status = "not done";
        tasks[i].timeCompleted = "";
      } else {
        // mark as done
        tasks[i].status = "done";
        tasks[i].timeCompleted = nowTimeStr();
      }

      saveTasks(tasks);
      renderAll();
    }

    function addNewTask() {
      const nameInput = document.getElementById("newTaskName");
      const prioSel   = document.getElementById("newTaskPriority");

      const nameVal = nameInput.value.trim();
      const prioVal = prioSel.value;

      if (!nameVal) {
        return;
      }

      const tasks = loadTasks();
      tasks.push(createTask({
        name: nameVal,
        priority: prioVal,
        status: "not done",
        timeCompleted: "",
        dateAssigned: todayISO()
      }));
      saveTasks(tasks);

      // clear input
      nameInput.value = "";
      prioSel.value = "low";

      renderAll();
    }

    /************************************
     * HISTORY RENDERING
     ************************************/
    let historyDate = todayISO();

    function renderHistory() {
      const tasks = loadTasks();
      const dayTasks = tasks.filter(t => t.dateAssigned === historyDate);

      const doneCt  = dayTasks.filter(t => t.status === "done").length;
      const totalCt = dayTasks.length;
      const pct     = totalCt > 0 ? Math.round((doneCt/totalCt)*100) : 0;

      // header labels
      document.getElementById("historyDateLabel").textContent = fmtDateDisplay(historyDate);
      document.getElementById("historyStats").textContent =
        `${doneCt} / ${totalCt} tasks done (${pct}%)`;

      // task list
      document.getElementById("historyTaskList").innerHTML = dayTasks.map(t => {
        return `
          <div class="history-task-card">
            <div class="task-name-history">${escapeHTML(t.name)}</div>
            <div class="task-meta-history">
              <b>Priority:</b> ${t.priority.toUpperCase()} |
              <b>Status:</b> ${t.status} |
              <b>Time:</b> ${t.timeCompleted || "—"}
            </div>
          </div>
        `;
      }).join("");
    }

    /************************************
     * SETTINGS: SYNC CODE (offline mode for now)
     ************************************/
    let currentUserId   = null; // local/offline stub
    let activeSyncCode  = null; // what we'd sync under

    // Stub functions to mimic future Firebase behavior safely
    // (So app won't crash even without Firebase config)
    function signInAnon() {
      return Promise.resolve().then(() => {
        // pretend we "signed in"
        currentUserId = loadSyncCode() || ("local-" + Math.random().toString(36).slice(2,7));
        // if we didn't have a sync code saved yet, use this and persist
        if (!loadSyncCode()) {
          saveSyncCode(currentUserId);
        }
        activeSyncCode = loadSyncCode();
      });
    }

    function uploadTasksToCloud(){ /* offline mode: no-op */ }
    function downloadTasksFromCloud(){ /* offline mode: no-op */ }
    function startRealtimeSync(){ /* offline mode: no-op */ }

    function updateSyncUI() {
      const codeField = document.getElementById("syncCodeDisplay");
      if (codeField) {
        codeField.value = activeSyncCode || "...";
      }
    }

    function bindCopySyncCode() {
      const btn = document.getElementById("copySyncCodeBtn");
      if (!btn) return;
      btn.addEventListener("click", () => {
        const codeField = document.getElementById("syncCodeDisplay");
        if (!codeField) return;
        codeField.select();
        codeField.setSelectionRange(0, 99999);
        try { document.execCommand("copy"); } catch(e) {}
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = "Copy"; }, 1500);
      });
    }

    function bindJoinSync() {
      const btn = document.getElementById("joinSyncBtn");
      if (!btn) return;
      btn.addEventListener("click", () => {
        const input = document.getElementById("syncCodeInput");
        if (!input) return;
        const newCode = input.value.trim();
        if (!newCode) return;

        // In offline mode we just store it locally.
        activeSyncCode = newCode;
        saveSyncCode(newCode);

        // these would sync tasks when cloud is live:
        startRealtimeSync();
        downloadTasksFromCloud();
        uploadTasksToCloud();

        updateSyncUI();

        btn.textContent = "Linked!";
        setTimeout(() => { btn.textContent = "Join"; }, 1500);
      });
    }

    /************************************
     * HEADER RENDER
     ************************************/
    function renderHeaderToday() {
      document.getElementById("todayDate").textContent = fmtDateDisplay(todayISO());
    }

    /************************************
     * UTIL
     ************************************/
    function escapeHTML(str){
      return str.replace(/[&<>"]/g, function(c){
        return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c];
      });
    }

    /************************************
     * RENDER ALL
     ************************************/
    function renderAll(){
      renderHeaderToday();
      renderTodayList();
      renderHistory();
      updateSyncUI();
    }

    /************************************
     * INIT (crash-safe)
     ************************************/
    function init(){
      // fade splash first no matter what
      hideSplashScreen();

      // bind add-task button
      const addBtn = document.getElementById("addTaskBtn");
      addBtn.addEventListener("click", addNewTask);

      // bind UI handlers for sync section
      try { bindCopySyncCode(); } catch(e){ console.log("bindCopySyncCode err", e); }
      try { bindJoinSync(); } catch(e){ console.log("bindJoinSync err", e); }

      // fake sign-in (local only) so sync code shows
      signInAnon().then(() => {
        try {
          updateSyncUI();
          downloadTasksFromCloud(); // currently no-op offline
        } catch(e) {
          console.log("post signInAnon err", e);
        }
      }).catch(err => {
        console.log("signInAnon failed", err);
      });

      // offline cache / service worker
      try {
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", function() {
            navigator.serviceWorker.register("sw.js");
          });
        }
      } catch(e) {
        console.log("SW err", e);
      }

      // first render
      try {
        renderAll();
      } catch(e) {
        console.log("renderAll err", e);
      }
    }

    /************************************
     * HISTORY NAV BUTTONS: after DOM is ready
     ************************************/
    document.addEventListener("DOMContentLoaded", () => {
      const prevBtn = document.getElementById("prevDayBtn");
      const nextBtn = document.getElementById("nextDayBtn");

      prevBtn.addEventListener("click", () => {
        historyDate = shiftDate(historyDate, -1);
        renderAll();
      });

      nextBtn.addEventListener("click", () => {
        historyDate = shiftDate(historyDate, 1);
        renderAll();
      });
    });

    // Kick off immediately
    init();
  </script>
</body>
</html>
